#!/usr/bin/env php
<?php

use Webgraphe\Phlip;

require_once 'vendor/autoload.php';

$options = [
    'verbose' => false
];
foreach ($argv as $arg) {
    if (preg_match("/^--([^=]+)=?(.+)?/", $arg, $matches)) {
        if (!isset($options[$matches[1]])) {
            echo "Unhandled option '--$matches[1]'" . PHP_EOL;
            exit(1);
        }

        $options[$matches[1]] = $matches[2] ?? true;
    }
}

$context = Phlip\Phlipy::context();

$context->define(
    'read',
    function () {
        $lines = [];
        while (true) {
            $line = rtrim(readline($lines ? '' : '> '));
            $break = !$line || '\\' !== $line[strlen($line) - 1];
            $lines[] = rtrim($line, '\\');
            if ($break) {
                break;
            }
        }

        return implode(PHP_EOL, $lines);
    }
);

$context->define(
    'evaluate',
    function ($source) use ($context) {
        try {
            return Phlip\Program::parse($source)->execute($context);
        } catch (\Throwable $t) {
            return $t;
        }
    }
);

$formBuilder = new Phlip\FormBuilder;
$stylizer = new Phlip\Stylizer(
    function (Phlip\Contracts\LexemeContract $lexeme): string {
        if ($lexeme instanceof Phlip\Symbol) {
            return "\033[1;37m{$lexeme}\033[0m";
        }

        if ($lexeme instanceof Phlip\Atom\NumberAtom) {
            return "\033[1;36m{$lexeme}\033[0m";
        }

        if ($lexeme instanceof Phlip\Atom\StringAtom) {
            return "\033[1;34m{$lexeme}\033[0m";
        }

        if ($lexeme instanceof Phlip\Atom\IdentifierAtom) {
            return "\033[1;33m{$lexeme}\033[0m";
        }

        if ($lexeme instanceof Phlip\Atom\KeywordAtom) {
            return "\033[1;32m{$lexeme}\033[0m";
        }

        return (string)$lexeme;
    }
);
$lexer = new Phlip\Lexer;

$context->define(
    'print',
    function ($result) use ($formBuilder, $stylizer, $lexer, $options) {
        $color = '1;30';
        $type = gettype($result);
        $extra = null;
        if ($result instanceof \Throwable) {
            $type = get_class($result);
            $output = $result->getMessage();
            if ($options['verbose']) {
                $extra = $result->getTraceAsString();
            }
            $color = '0;31';
        } else {
            if (is_object($result)) {
                $type = get_class($result);
            }

            $form = $formBuilder->asForm($result);
            $output = $stylizer->stylizeLexemeStream($lexer->parseSource((string)$form));
        }

        if ($type) {
            echo "\033[{$color}m{$type}\033[0m" . PHP_EOL;
        }
        if (strlen($output = trim($output))) {
            echo $output . PHP_EOL;
        }
        if (strlen($extra = trim($extra))) {
            echo trim($extra) . PHP_EOL;
        }

        echo PHP_EOL;

        return true;
    }
);

$context->define(
    'exit',
    function ($code = 0) {
        echo "Good bye!" . PHP_EOL . PHP_EOL;
        exit($code);
    }
);

$context->define('loop', $context->get('while'));

echo 'Go crazy, you may just "phlip" ;p' . PHP_EOL;
echo "Type " . $stylizer->stylizeSource('(exit)', $lexer) . " to quit." . PHP_EOL . PHP_EOL;

Phlip\Program::parse('(loop (print (evaluate (read))))')->execute($context);
